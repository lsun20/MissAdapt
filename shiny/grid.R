# Precompute the function
st_thresholds_grid <- c(1.57482766198508, 1.55125499909256, 1.52742074353448, 1.50334882329505, 1.47906233490077, 
                        1.45458150029266, 1.4299270409132, 1.40512383967876, 1.38019303478176, 1.35515605260822, 
                        1.33003227704614, 1.30483757026634, 1.27959849366401, 1.25433502048039, 1.22906433002374, 
                        1.20379862855458, 1.17856184780166, 1.15337076343841, 1.12824236155291, 1.10319422804627, 
                        1.07824432631491, 1.05340561586754, 1.02870454439195, 1.00416561484403, 0.979813578603983, 
                        0.955673742841495, 0.931764912197942, 0.908115155200027, 0.884752852219577, 0.861705205296034, 
                        0.838984986407601, 0.816633434009214, 0.794675112145209, 0.7731297065466, 0.752040905293611, 
                        0.731416663001888, 0.711309030584423, 0.69172503640683, 0.672713172851095, 0.654291308290986, 
                        0.636491137084625, 0.619350676770425, 0.602881936878391, 0.58712468096191, 0.57210936993747, 
                        0.557856650375231, 0.544387216517243, 0.531735712033272, 0.519924940086376, 0.508976432315778, 
                        0.498906428201768, 0.489732214564344, 0.481477367692955, 0.474157387541963, 0.467784346318755, 
                        0.462372207805892, 0.457930286791032, 0.454466861185033, 0.451997110894451, 0.450509551844624)

B = 9;
b_grid <- seq(-B, B, 0.05)
Kb <- length(b_grid)

rho_tbl <- data.frame(
  V1 = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0,
         1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.0,
         2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9, 3.0,
         3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 4.0,
         4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9, 5.0,
         5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 6.0,
         6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9, 7.0,
         7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 8.0,
         8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7, 8.8, 8.9, 9.0),
  V2 = c(0.009901078, 0.038461442, 0.082545237, 0.137720131, 0.199021684, 0.261577440,
         0.321039555, 0.373847194, 0.417355386, 0.449863204, 0.471754896, 0.492436768,
         0.513709998, 0.535200837, 0.556503872, 0.577192094, 0.596829224, 0.614983746,
         0.631243828, 0.645232190, 0.657717288, 0.669912144, 0.681801925, 0.693338275,
         0.704481717, 0.715127809, 0.725188312, 0.734563050, 0.743139180, 0.751149978,
         0.758888139, 0.766359368, 0.773569395, 0.780507459, 0.787155471, 0.793481507,
         0.799462342, 0.805082646, 0.810476732, 0.815679281, 0.820700443, 0.825541810,
         0.830203342, 0.834677332, 0.838959389, 0.843039315, 0.846958242, 0.850744867,
         0.854403240, 0.857937710, 0.861351001, 0.864643190, 0.867813003, 0.870858050,
         0.873796003, 0.876638978, 0.879392738, 0.882059029, 0.884640495, 0.887138219,
         0.889551698, 0.891883875, 0.894141903, 0.896333082, 0.898458833, 0.900521492,
         0.902523491, 0.904465166, 0.906347814, 0.908173076, 0.909945978, 0.911669917,
         0.913346272, 0.914975637, 0.916560359, 0.918101263, 0.919598463, 0.921054623,
         0.922472144, 0.923852643, 0.925197859, 0.926507996, 0.927784307, 0.929027313,
         0.930238665, 0.931419094, 0.932569572, 0.933692931, 0.934788964, 0.935857989)
)

rho_b_over_sigma_function<- splinefun(rho_tbl$V1, rho_tbl$V2, method = "fmm", ties = mean)
rho_b_over_sigma <- rho_b_over_sigma_function(abs(b_grid))

flci_adaptive_st_cv_grid <- c(1.43, 1.44, 1.43, 1.43, 1.44, 1.44, 1.44, 1.44, 1.44, 1.45, 
                              1.45, 1.45, 1.46, 1.46, 1.47, 1.47, 1.48, 1.49, 1.49, 1.50, 
                              1.51, 1.52, 1.53, 1.54, 1.55, 1.56, 1.57, 1.59, 1.60, 1.61, 
                              1.63, 1.64, 1.66, 1.67, 1.69, 1.70, 1.71, 1.73, 1.74, 1.76, 
                              1.77, 1.79, 1.80, 1.82, 1.83, 1.85, 1.86, 1.87, 1.89, 1.90, 
                              1.91, 1.92, 1.93, 1.94, 1.95, 1.96, 1.96, 1.97, 1.97, 1.97)